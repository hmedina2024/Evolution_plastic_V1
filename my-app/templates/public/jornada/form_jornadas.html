{% extends 'public/base_cpanel.html' %}

{% block customCSS %}
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/file.css') }}" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/css/bootstrap-select.min.css" />
{% endblock %}

{% block body %}
<div class="card" style="border-radius: 0px !important">
  <div class="row justify-content-center mb-2">
    <div class="col-md-12">
      <h3 class="text-center mt-5 mb-3 fw-bold">REGISTRO DE JORNADAS</h3>
      <hr />
    </div>
  </div>
  <div class="row justify-content-center mb-2">
    <div class="col-md-11">
      <form class="form-horizontal mx-auto" method="POST" action="/form-registrar-jornada" autocomplete="off" enctype="multipart/form-data">
        <div class="row">
          <div class="col-md-4">
            <label for="nombre_empleado" class="form-label fw-bold text-primary">Nombre Empleado</label>
            <select name="nombre_empleado" id="nombre_empleado" class="form-control selectpicker"
                    title="Seleccionar Empleado" data-live-search="true" data-hide-disabled="true" required>
              <option value="">Cargando...</option> <!-- Placeholder inicial -->
            </select>
          </div>
          <div class="row mt-4">
            <div class="col-md-3">
              <label for="fecha_hora_llegada_programada" class="form-label fw-bold text-primary" title="FH. Llegada programada">
                FH. Llegada programada
              </label>
              <input class="form-control" type="datetime-local" id="fecha_hora_llegada_programada" name="fecha_hora_llegada_programada" required />
            </div>
            <div class="col-md-3">
              <label for="fecha_hora_salida_programada" class="form-label fw-bold text-primary">FH. Salida programada</label>
              <input class="form-control" type="datetime-local" name="fecha_hora_salida_programada" id="fecha_hora_salida_programada" required />
            </div>
            <div class="col-md-6">
              <label for="novedad_jornada_programada" class="form-label fw-bold text-primary">NOVEDADES DE LA JORNADA PROGRAMADA</label>
              <textarea class="form-control" name="novedad_jornada_programada" rows="1"></textarea>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-md-3">
              <label for="fecha_hora_llegada" class="form-label fw-bold text-primary">FH. Llegada Real</label>
              <input class="form-control" type="datetime-local" name="fecha_hora_llegada" required />
            </div>
            <div class="col-md-3">
              <label for="fecha_hora_salida" class="form-label fw-bold text-primary">FH. Salida Real</label>
              <input class="form-control" type="datetime-local" name="fecha_hora_salida" required />
            </div>
            <div class="col-md-6">
              <label for="novedad_jornada" class="form-label fw-bold text-primary">NOVEDADES DE LA JORNADA REAL</label>
              <textarea class="form-control" name="novedad_jornada" rows="1"></textarea>
            </div>
          </div>
          <div class="mb-3 mt-4 text-center">
            <button type="submit" class="btn rounded-pill btn-primary">
              Guardar registro ahora
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block customJS %}
<script src="{{ url_for('static', filename='assets/customJS/file.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.2/js/bootstrap-select.min.js"></script>
<script>
$(document).ready(function () {
  console.log("Documento listo, inicializando selectpicker...");

  // Verificar carga de dependencias
  if (typeof jQuery === 'undefined') console.error("jQuery no se cargó correctamente");
  if (typeof bootstrap === 'undefined') console.error("Bootstrap no se cargó correctamente");
  if (typeof $.fn.selectpicker === 'undefined') console.error("Bootstrap Select no se cargó correctamente");

  // Inicializar selectpicker
  $("#nombre_empleado").selectpicker({
    liveSearch: true,
    liveSearchStyle: 'contains',
    liveSearchNormalize: true,
    size: 10,
    noneSelectedText: 'Seleccionar...',
    actionsBox: true
  });

  // Función para cargar opciones
  function loadOptions(selectId, url, dataKey, valueKey, textKey) {
    console.log(`Cargando opciones para ${selectId} desde ${url}`);
    $.ajax({
      url: url,
      method: "GET",
      dataType: "json",
      success: function(data) {
        console.log(`Datos recibidos para ${selectId}:`, data);
        let options = '<option value="">Seleccionar...</option>';
        if (data[dataKey] && Array.isArray(data[dataKey]) && data[dataKey].length > 0) {
          data[dataKey].forEach(item => {
            options += `<option value="${item[valueKey] || ''}">${item[textKey] || ''}</option>`;
          });
        } else {
          options += '<option value="">No hay opciones disponibles</option>';
        }
        $(`#${selectId}`).html(options).selectpicker('refresh');
      },
      error: function(xhr, status, error) {
        console.error(`Error al cargar opciones para ${selectId}:`, error, xhr.responseText);
        $(`#${selectId}`).html('<option value="">Error al cargar...</option>').selectpicker('refresh');
      }
    });
  }

  // Función para búsqueda dinámica
  function searchOptions(selectId, url, dataKey, valueKey, textKey, searchTerm) {
    console.log(`Buscando en ${selectId} con término: ${searchTerm}`);
    $.ajax({
      url: url,
      method: "GET",
      data: { search: searchTerm },
      dataType: "json",
      success: function(data) {
        console.log(`Resultados de búsqueda para ${selectId}:`, data);
        let options = '<option value="">Seleccionar...</option>';
        if (data[dataKey] && Array.isArray(data[dataKey])) {
          data[dataKey].forEach(item => {
            options += `<option value="${item[valueKey] || ''}">${item[textKey] || ''}</option>`;
          });
        } else {
          options += '<option value="">No se encontraron resultados</option>';
        }
        $(`#${selectId}`).html(options).selectpicker('refresh');
      },
      error: function(xhr, status, error) {
        console.error(`Error al buscar en ${selectId}:`, error, xhr.responseText);
        $(`#${selectId}`).html('<option value="">Error al buscar...</option>').selectpicker('refresh');
      }
    });
  }

  // Evento para búsqueda dinámica
  $("#nombre_empleado").on('input', '.bs-searchbox input', function(e) {
    let selectId = $(this).closest('.bootstrap-select').find('select').attr('id');
    let searchTerm = e.target.value.trim();
    if (searchTerm.length > 0) {  // Solo buscar si hay al menos un carácter
      searchOptions(selectId, "/api/empleados", "empleados", "nombre_empleado", "nombre_empleado", searchTerm);
    } else {
      loadOptions(selectId, "/api/empleados", "empleados", "nombre_empleado", "nombre_empleado");
    }
  });

  // Cargar datos iniciales
  loadOptions("nombre_empleado", "/api/empleados", "empleados", "nombre_empleado", "nombre_empleado");
});

// Mantener las funciones de fecha por defecto
document.addEventListener('DOMContentLoaded', function() {
  const fechaHoraLlegada = document.getElementById('fecha_hora_llegada_programada');
  const fechaHoraSalida = document.getElementById('fecha_hora_salida_programada');
  const now = new Date();
  const año = now.getFullYear();
  const mes = (now.getMonth() + 1).toString().padStart(2, '0');
  const dia = now.getDate().toString().padStart(2, '0');

  const llegadaDefault = `${año}-${mes}-${dia}T06:00`;
  const salidaDefault = `${año}-${mes}-${dia}T14:00`;

  fechaHoraLlegada.value = llegadaDefault;
  fechaHoraSalida.value = salidaDefault;
});
</script>
{% endblock %}