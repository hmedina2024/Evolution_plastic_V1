{% extends 'public/base_cpanel.html' %}

{% block title %}Registrar Orden de Producción{% endblock %}

{% block customCSS %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/file.css') }}" />
<style>
  .is-invalid-select2 .select2-selection {
    border-color: #dc3545 !important;
  }
  .piece-form-group {
    transition: all 0.3s ease-in-out;
  }
  /* Estilo para resaltar el contenedor de Select2 cuando es inválido */
    .select2-container.is-invalid-select2 .select2-selection {
        border-color: #dc3545; /* Color de borde de Bootstrap para inválido */
    }
</style>
{% endblock %}

{% block body %}
<div class="card shadow-sm" style="border-radius: 10px;">
  <div class="card-header bg-primary text-white text-center">
    <h3 class="fw-bold">REGISTRAR NUEVA ORDEN DE PRODUCCIÓN</h3>
  </div>
  <div class="card-body p-4">
    <form class="form-horizontal mx-auto needs-validation" method="POST" action="/form-registrar-op" autocomplete="off" enctype="multipart/form-data" id="registroForm" novalidate>
      <div class="row g-4">
        <div class="col-md-2 position-relative">
          <label for="fecha" class="form-label fw-bold text-primary">Fecha: <span class="text-danger">*</span></label>
          <input class="form-control" type="date" name="fecha" id="fecha" required>
          <div class="invalid-feedback">Por favor, ingrese la fecha.</div>
        </div>
        <div class="col-md-2">
          <label for="cod_op" class="form-label fw-bold text-primary">COD. OP <span class="text-danger">*</span></label>
          <input class="form-control" type="text" name="cod_op" id="cod_op" value="{{ codigo_op }}" readonly required>
          <div id="cod_op-error" class="text-danger small mt-1"></div>
          <div class="invalid-feedback">Por favor, ingrese el código OP.</div>
        </div>
        <div class="col-md-4" style="display: none;">
          <label for="version" class="form-label fw-bold text-primary">VERSIÓN OP</label>
          <input type="text" name="version" id="version" class="form-control">
        </div>
        <div class="col-md-2">
          <label for="cotizacion" class="form-label fw-bold text-primary">COTIZACIÓN: <span class="text-danger">*</span></label>
          <input type="text" name="cotizacion" id="cotizacion" class="form-control" required>
          <div class="invalid-feedback">Por favor, ingrese la cotización.</div>
        </div>
        <div class="col-md-2">
          <label for="odi" class="form-label fw-bold text-primary">ODI <span class="text-danger">*</span></label>
          <input type="text" name="odi" id="odi" class="form-control" required>
          <div class="invalid-feedback">Por favor, ingrese el ODI.</div>
        </div>
        <div class="col-md-4">
          <label for="id_cliente" class="form-label fw-bold text-primary">NOMBRE CLIENTE <span class="text-danger">*</span></label>
          <select name="id_cliente" id="id_cliente" class="form-control select2" required></select>
          <div class="invalid-feedback">Por favor, seleccione un cliente.</div>
        </div>
        <div class="col-md-4">
          <label for="producto" class="form-label fw-bold text-primary">PRODUCTO</label>
          <input type="text" name="producto" id="producto" class="form-control">
        </div>
        <div class="col-md-2">
          <label for="cantidad" class="form-label fw-bold text-primary">Cantidad OP<span class="text-danger">*</span></label>
          <input class="form-control" type="text" name="cantidad" id="cantidad" required pattern="[0-9]*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57">
          <div class="invalid-feedback">Por favor, ingrese la cantidad.</div>
        </div>
        <div class="col-md-2">
          <label for="medida" class="form-label fw-bold text-primary">UNIDAD DE MEDIDA</label>
          <input type="text" name="medida" id="medida" class="form-control">
        </div>
        <div class="col-md-4">
          <label for="referencia" class="form-label fw-bold text-primary">REFERENCIA</label>
          <input type="text" name="referencia" id="referencia" class="form-control">
        </div>
        <div class="col-md-5">
          <label for="id_empleado" class="form-label fw-bold text-primary">Nombre Vendedor <span class="text-danger">*</span></label>
          <select name="id_empleado" id="id_empleado" class="form-control select2" required></select>
          <div class="invalid-feedback">Por favor, seleccione un vendedor.</div>
        </div>
        <div class="col-md-3 position-relative">
          <label for="fecha_entrega" class="form-label fw-bold text-primary">FECHA DE ENTREGA <span class="text-danger">*</span></label>
          <input class="form-control" type="date" name="fecha_entrega" id="fecha_entrega" required>
          <div class="invalid-feedback">Por favor, ingrese la fecha de entrega.</div>
        </div>
      </div>
      <div class="row g-4 mt-3">
        <div class="col-md-4">
          <label for="descripcion_general_op" class="form-label fw-bold text-primary">DESCRIPCIÓN GENERAL (ORDEN) <span class="text-danger">*</span></label>
          <textarea class="form-control" id="descripcion_general_op" name="descripcion_general_op" rows="10" required></textarea>
          <div class="invalid-feedback">Por favor, ingrese la descripción general de la orden.</div>
        </div>
        <div class="col-md-4">
          <label for="render" class="form-label fw-bold text-primary">RENDER APROBADO</label>
          {% set url_render = url_for('static', filename='assets/img/Prototipo.png') %}
          <div class="render-upload-container" id="imagePreview" style="background-image: url('{{ url_render }}');">
            <input type="file" id="imageUpload" name="render" accept=".png, .jpg, .jpeg" class="render-upload-input">
            <label for="imageUpload" class="render-upload-label">
              <i class="bi bi-upload"></i> Cambiar
            </label>
            <button type="button" class="render-delete-btn" id="deleteImageBtn" style="display: none;">
              <i class="bi bi-x-circle"></i> Quitar
            </button>
          </div>
        </div>
        <div class="col-md-4">
          <label for="documentos" class="form-label fw-bold text-primary">Cargar Documentos</label>
          <input class="form-control" type="file" name="documentos" id="documentos" accept="*" multiple>
          <ul class="list-group mt-2" id="fileList"></ul>
        </div>
      </div>
      
      <hr class="my-4">
      <h4 class="text-primary mb-3">Piezas de la Orden de Producción</h4>
      <div id="dynamicFormsContainer">
        <!-- Las piezas se agregarán aquí -->
      </div>
      <button type="button" id="addPieceBtn" class="btn btn-primary mt-2 mb-3">
        <i class="bi bi-plus-circle me-1"></i> Agregar Pieza
      </button>
      <hr class="my-4">

      <div class="row mt-2 g-4">
        <div class="col-md-5">
          <label for="empaque" class="form-label fw-bold text-primary">EMPAQUE</label>
          <input type="text" name="empaque" id="empaque" class="form-control">
        </div>
        <div class="col-md-4">
          <label for="id_supervisor" class="form-label fw-bold text-primary">Supervisor</label>
          <select name="id_supervisor" id="id_supervisor" class="form-control select2"></select>
        </div>
        <div class="col-md-3">
          <label for="estado" class="form-label fw-bold text-primary">ESTADO <span class="text-danger">*</span></label>
          <select name="estado" id="estado" class="form-control select2" required>
            <option value="" disabled selected>Seleccionar Estado</option>
            <option value="ANULA">ANULA</option>
            <option value="FACTU">FACTU</option>
            <option value="CRUCE">CRUCE</option>
            <option value="INV">INV</option>
            <option value="LP">LP</option>
            <option value="NC">NC</option>
            <option value="PR">PR</option>
            <option value="PR CR">PR CR</option>
            <option value="TER">TER</option>
          </select>
          <div class="invalid-feedback">Por favor, seleccione un estado.</div>
        </div>
      </div>
      <div class="row mt-4">
        <div class="col-md-12">
          <label for="materiales_op" class="form-label fw-bold text-primary">MATERIALES (ORDEN GENERAL) <span class="text-danger">*</span></label>
          <textarea class="form-control" id="materiales_op" name="materiales_op" rows="3" required></textarea>
          <div class="invalid-feedback">Por favor, ingrese los materiales generales de la orden.</div>
        </div>
      </div>
      <input type="hidden" name="piezasData" id="piezasData">
      <div class="text-center mt-5">
        <button type="submit" class="btn btn-primary rounded-pill px-4">
          Guardar Registro <i class="bi bi-save ms-2"></i>
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block customJS %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function () {
  console.log("Document ready y script de form_op.html INICIADO."); // DEBUG INICIAL

  // --- INICIO: Lógica para "Render Aprobado" ---
  const imageUpload = document.getElementById('imageUpload');
  const imagePreview = document.getElementById('imagePreview');
  const deleteImageBtn = document.getElementById('deleteImageBtn');
  let defaultImage = '';

  if (imagePreview) {
    defaultImage = imagePreview.style.backgroundImage;
  }

  if (imageUpload && imagePreview && deleteImageBtn) {
    imageUpload.addEventListener('change', function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          imagePreview.style.backgroundImage = `url('${e.target.result}')`;
          deleteImageBtn.style.display = 'block';
        }
        reader.readAsDataURL(file);
      }
    });

    deleteImageBtn.addEventListener('click', function () {
      imagePreview.style.backgroundImage = defaultImage;
      imageUpload.value = '';
      deleteImageBtn.style.display = 'none';
    });
  }
  // --- FIN: Lógica para "Render Aprobado" ---

  // --- INICIO: Lógica para "Cargar Documentos" ---
  let selectedFiles = []; 
  const documentosInput = document.getElementById('documentos');
  const fileListUl = document.getElementById('fileList');

  function renderFileList() {
    fileListUl.innerHTML = ''; 
    if (selectedFiles.length > 0) {
      selectedFiles.forEach((file, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center py-1 px-2';
        const fileNameSpan = document.createElement('span');
        fileNameSpan.textContent = `${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
        li.appendChild(fileNameSpan);
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-danger btn-sm py-0 px-1';
        deleteBtn.innerHTML = '<i class="bi bi-trash" style="font-size: 0.8rem;"></i>';
        deleteBtn.title = 'Eliminar archivo';
        deleteBtn.addEventListener('click', function() { removeFileFromList(index); });
        li.appendChild(deleteBtn);
        fileListUl.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.className = 'list-group-item text-muted py-1 px-2';
      li.textContent = 'Ningún documento adjunto.';
      fileListUl.appendChild(li);
    }
  }

  function removeFileFromList(indexToRemove) {
    selectedFiles.splice(indexToRemove, 1); 
    renderFileList(); 
  }

  if (documentosInput && fileListUl) {
    documentosInput.addEventListener('change', function (event) {
      const newFiles = Array.from(event.target.files);
      newFiles.forEach(newFile => {
        if (!selectedFiles.some(existingFile => existingFile.name === newFile.name)) {
          selectedFiles.push(newFile);
        }
      });
      renderFileList(); 
      event.target.value = null; 
    });
  }
  renderFileList();
  // --- FIN: Lógica para "Cargar Documentos" ---

  function setupSelect2(selector, url, placeholder, dataKey, keyId, keyText, isMultiple = false, tags = false, allowClearOverride = true) {
    const $select = $(selector);
    $select.select2({
        placeholder: placeholder,
        allowClear: allowClearOverride, // Usar el override
        minimumInputLength: 0,
        dropdownAutoWidth: true,
        width: '100%',
        multiple: isMultiple,
        tags: tags,
        ajax: {
            url: url,
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { search: params.term || '', page: params.page || 1, per_page: 10 };
            },
            processResults: function (data, params) {
                params.page = params.page || 1;
                let items = [];
                if (data && data[dataKey] && Array.isArray(data[dataKey])) {
                    items = data[dataKey];
                } else if (data && Array.isArray(data)) {
                    items = data;
                }
                return {
                    results: items.map(item => ({ id: item[keyId], text: item[keyText] })),
                    pagination: { more: items.length === 10 }
                };
            },
            cache: true
        },
        templateResult: function (data) { return data.text; },
        templateSelection: function (data) { return data.text || data.id; }
    }).on('select2:open', function () {
        setTimeout(() => {
            const searchField = document.querySelector('.select2-container--open .select2-search__field');
            if (searchField) { searchField.focus(); }
        }, 50);
    });
}

  setupSelect2('#id_cliente', '/api/clientes', 'Seleccionar Cliente', 'clientes', 'id_cliente', 'nombre_cliente');
  setupSelect2('#id_empleado', '/api/empleados', 'Seleccionar Vendedor', 'empleados', 'id_empleado', 'nombre_empleado');
  setupSelect2('#id_supervisor', '/api/supervisores', 'Seleccionar Supervisor', 'supervisores', 'id_empleado', 'nombre_empleado', false, false, true);
  setupSelect2('#estado', '', 'Seleccionar Estado', '', '', '', false, false, true); // Estado no usa AJAX
  //setupSelect2('id_pieza', '/api/piezas', 'Seleccionar Pieza', 'piezas', 'id_pieza', 'nombre_pieza'); // Movido a lógica de piezas dinámicas

  $('#estado').select2({ placeholder: 'Seleccionar Estado', allowClear: true, minimumResultsForSearch: Infinity, width: '100%' });

  // --- INICIO: Lógica para Piezas Dinámicas ---
  let pieceCounter = 0;
  const MAX_PIECES = 15; 

  $('#addPieceBtn').click(function() {
    if ($('.piece-form-group').length >= MAX_PIECES) {
      alert(`No se pueden agregar más de ${MAX_PIECES} piezas.`);
      return;
    }
    pieceCounter++;
    const pieceIdSuffix = `p${pieceCounter}`;

    const newPieceFormHtml = `
        <div class="piece-form-group border rounded p-3 mt-3 bg-light shadow-sm" id="piece-group-${pieceIdSuffix}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold text-success mb-0">Pieza #${pieceCounter}</h5>
                <button type="button" class="btn btn-danger btn-sm removePieceBtn" title="Quitar esta pieza">
                    <i class="bi bi-x-lg"></i> Quitar
                </button>
            </div>
            <hr class="mt-1 mb-3">
            <div class="row g-3">
                <div class="col-md-6 col-lg-3">
                    <label for="pieza_nombre_${pieceIdSuffix}" class="form-label">Nombre Pieza <span class="text-danger">*</span></label>
                    <select name="pieza_id_pieza_${pieceIdSuffix}" id="pieza_id_pieza_${pieceIdSuffix}" class="form-control select2-dynamic-piece pieza-campo pieza-nombre" required></select>
                    <div class="invalid-feedback">Por favor, seleccione una pieza.</div>
                </div>
                <div class="col-md-6 col-lg-2">
                    <label for="pieza_cantidad_${pieceIdSuffix}" class="form-label">Cantidad <span class="text-danger">*</span></label>
                    <input type="number" name="pieza_cantidad_${pieceIdSuffix}" id="pieza_cantidad_${pieceIdSuffix}" class="form-control pieza-campo pieza-cantidad" required min="1" value="1">
                    <div class="invalid-feedback">Cantidad > 0 requerida.</div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="pieza_tamano_${pieceIdSuffix}" class="form-label">Tamaño</label>
                    <input type="text" name="pieza_tamano_${pieceIdSuffix}" id="pieza_tamano_${pieceIdSuffix}" class="form-control pieza-tamano">
                </div>
                 <div class="col-md-6 col-lg-4">
                    <label for="pieza_material_${pieceIdSuffix}" class="form-label">Material</label>
                    <input type="text" name="pieza_material_${pieceIdSuffix}" id="pieza_material_${pieceIdSuffix}" class="form-control pieza-material">
                </div>
            </div>
            <div class="row g-3 mt-1">
                <div class="col-md-6 col-lg-3">
                    <label for="pieza_montaje_${pieceIdSuffix}" class="form-label">Montaje</label>
                    <input type="text" name="pieza_montaje_${pieceIdSuffix}" id="pieza_montaje_${pieceIdSuffix}" class="form-control pieza-montaje">
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="pieza_tamano_montaje_${pieceIdSuffix}" class="form-label">Tamaño del Montaje</label>
                    <input type="text" name="pieza_tamano_montaje_${pieceIdSuffix}" id="pieza_tamano_montaje_${pieceIdSuffix}" class="form-control pieza-tamano-montaje">
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="pieza_cantidad_material_${pieceIdSuffix}" class="form-label">Cantidad Material</label>
                    <input type="text" name="pieza_cantidad_material_${pieceIdSuffix}" id="pieza_cantidad_material_${pieceIdSuffix}" class="form-control pieza-cantidad-material">
                </div>
            </div>
            <div class="row g-3 mt-1">
                <div class="col-md-12 col-lg-6">
                    <label for="pieza_id_proceso_${pieceIdSuffix}" class="form-label">Proceso(s) <span class="text-danger">*</span></label>
                    <select name="pieza_id_proceso_${pieceIdSuffix}" id="pieza_id_proceso_${pieceIdSuffix}" class="form-control select2-dynamic-piece pieza-campo pieza-proceso" required multiple="multiple" style="width:100%;"></select>
                    <div class="invalid-feedback">Proceso requerido.</div>
                </div>
                <div class="col-md-12 col-lg-6" id="otro_proceso_container_${pieceIdSuffix}" style="display:none;">
                    <label for="pieza_otro_proceso_${pieceIdSuffix}" class="form-label">Otro Proceso (especificar) <span class="text-danger">*</span></label>
                    <input type="text" name="pieza_otro_proceso_${pieceIdSuffix}" id="pieza_otro_proceso_${pieceIdSuffix}" class="form-control pieza-otro-proceso">
                    <div class="invalid-feedback">Especifique el otro proceso.</div>
                </div>
            </div>
            <div class="row g-3 mt-1">
                <div class="col-md-12">
                    <label for="pieza_descripcion_${pieceIdSuffix}" class="form-label">Descripción Pieza</label>
                    <textarea name="pieza_descripcion_${pieceIdSuffix}" id="pieza_descripcion_${pieceIdSuffix}" class="form-control pieza-descripcion" rows="2"></textarea>
                </div>
            </div>
        </div>`;
    $('#dynamicFormsContainer').append(newPieceFormHtml);

    // Inicializar Select2 para el campo "Nombre Pieza"
    setupSelect2(`#pieza_id_pieza_${pieceIdSuffix}`, '/api/piezas', 'Seleccionar Pieza', 'piezas', 'id_pieza', 'nombre_pieza', false, false, true);
    
    const $procesoSelect = $(`#pieza_id_proceso_${pieceIdSuffix}`);
    $procesoSelect.select2({
        placeholder: 'Seleccionar Proceso(s) o escribir "Otro"',
        allowClear: true,
        tags: true, 
        tokenSeparators: [',', ' '],
        width: '100%',
        ajax: {
            url: '/api/procesos', 
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { search: params.term || '', page: params.page || 1, per_page: 10 };
            },
            processResults: function (data, params) {
                let items = [];
                if (data && data.procesos && Array.isArray(data.procesos)) {
                    items = data.procesos;
                }
                // Agregar la opción "Otro" si no está presente y el término de búsqueda coincide
                if (params.term && params.term.toLowerCase().startsWith('otro') && !items.some(item => item.id_proceso === 'otro_proceso_custom')) {
                     // No agregarla aquí directamente, dejar que createTag la maneje si es necesario
                }
                return {
                    results: items.map(item => ({ id: item.id_proceso, text: item.nombre_proceso })),
                    pagination: { more: items.length === 10 }
                };
            },
            cache: true
        },
        createTag: function (params) {
            var term = $.trim(params.term);
            if (term === '') { return null; }
            if (term.toLowerCase() === 'otro') {
                return { id: 'otro_proceso_custom', text: 'Otro (especificar)' };
            }
            // Para evitar crear tags no deseados si el usuario solo está escribiendo parte de un proceso existente
            // Podríamos deshabilitar la creación de tags si no es "Otro"
            // return null; 
            return { id: term, text: term + ' (nuevo proceso)' }; // O permitir crear nuevos procesos directamente
        }
    }).on('change', function(e) {
        const $select = $(this);
        const $pieceGroup = $select.closest('.piece-form-group');
        const $otroContainer = $pieceGroup.find(`[id^="otro_proceso_container_"]`);
        const $otroInput = $pieceGroup.find(`[id^="pieza_otro_proceso_"]`);
        
        const selectedValues = $select.val();
        if (Array.isArray(selectedValues) && selectedValues.includes('otro_proceso_custom')) {
            $otroContainer.show();
            $otroInput.prop('required', true);
        } else {
            $otroContainer.hide();
            $otroInput.val('').prop('required', false).removeClass('is-invalid');
        }
    });
  });

  $('#dynamicFormsContainer').on('click', '.removePieceBtn', function() {
    $(this).closest('.piece-form-group').remove();
  });
  // --- FIN: Lógica para Piezas Dinámicas ---

  $('#fecha, #fecha_entrega').on('change', function () {
    const fechaRegistroStr = $('#fecha').val();
    const fechaEntregaStr = $('#fecha_entrega').val();
    if (fechaRegistroStr && fechaEntregaStr) {
        const fechaRegistro = new Date(fechaRegistroStr + "T00:00:00"); // Asegurar que se tome como inicio del día
        const fechaEntrega = new Date(fechaEntregaStr + "T00:00:00");
        if (fechaEntrega < fechaRegistro) {
            alert('La fecha de entrega no puede ser anterior a la fecha de registro.');
            $('#fecha_entrega').val('').addClass('is-invalid').focus();
            $('#fecha_entrega')[0].setCustomValidity('La fecha de entrega no puede ser anterior a la fecha de registro.');
        } else {
            $('#fecha_entrega').removeClass('is-invalid');
            $('#fecha_entrega')[0].setCustomValidity(''); 
        }
    } else {
         $('#fecha_entrega')[0].setCustomValidity(''); 
    }
  });

  let isSubmitting = false;
  const submitBtn = $('#registroForm button[type="submit"]');

  $('#registroForm').on('submit', function (e) {
    e.preventDefault(); 
    const form = this;
    let formValido = form.checkValidity(); 

    const fechaRegistroStr = $('#fecha').val();
    const fechaEntregaStr = $('#fecha_entrega').val();
    if (fechaRegistroStr && fechaEntregaStr) {
        const fechaRegistro = new Date(fechaRegistroStr + "T00:00:00");
        const fechaEntrega = new Date(fechaEntregaStr + "T00:00:00");
        if (fechaEntrega < fechaRegistro) {
            $('#fecha_entrega').addClass('is-invalid').focus();
            $('#fecha_entrega')[0].setCustomValidity('La fecha de entrega no puede ser anterior a la fecha de registro.');
            formValido = false;
        } else {
             $('#fecha_entrega')[0].setCustomValidity('');
        }
    }
    
    let piezasValidas = true;
    const piezasArray = [];
    $('.piece-form-group').each(function(index) {
        const $pieceGroup = $(this);
        let piezaActualValida = true;
        
        const nombreInput = $pieceGroup.find('.pieza-nombre');
        const cantidadInput = $pieceGroup.find('.pieza-cantidad');
        const procesoSelect = $pieceGroup.find('.pieza-proceso');
        const otroProcesoInput = $pieceGroup.find('.pieza-otro-proceso');

        if (!nombreInput.val()) { nombreInput.addClass('is-invalid'); piezaActualValida = false; } else { nombreInput.removeClass('is-invalid'); }
        if (!cantidadInput.val() || parseInt(cantidadInput.val()) < 1) { cantidadInput.addClass('is-invalid'); piezaActualValida = false; } else { cantidadInput.removeClass('is-invalid'); }
        
        const procesosSeleccionados = procesoSelect.val();
        if (!procesosSeleccionados || procesosSeleccionados.length === 0) {
            procesoSelect.next('.select2-container').addClass('is-invalid-select2'); piezaActualValida = false;
        } else {
            procesoSelect.next('.select2-container').removeClass('is-invalid-select2');
            if (procesosSeleccionados.includes('otro_proceso_custom') && !otroProcesoInput.val().trim()) {
                otroProcesoInput.addClass('is-invalid'); // No enfocar aquí, se hará globalmente
                piezaActualValida = false;
            } else {
                otroProcesoInput.removeClass('is-invalid');
            }
        }
        
        if (!piezaActualValida) { piezasValidas = false; }

        if (nombreInput.val() && cantidadInput.val() && procesosSeleccionados && procesosSeleccionados.length > 0) {
            let idsProcesosParseados = [];
            let otroProcesoTexto = null;
            if (Array.isArray(procesosSeleccionados)) {
                procesosSeleccionados.forEach(procId => {
                    if (procId === 'otro_proceso_custom') {
                        if (otroProcesoInput.val().trim()) {
                            otroProcesoTexto = otroProcesoInput.val().trim(); 
                        }
                    } else if (!isNaN(parseInt(procId))) { // Asegurarse que es un ID numérico
                        idsProcesosParseados.push(parseInt(procId));
                    }
                    // Ignorar tags que no sean 'otro_proceso_custom' y no sean numéricos
                });
            }
             // Si solo se seleccionó "Otro" y se especificó, ids_procesos puede quedar vacío.
            if (otroProcesoTexto && idsProcesosParseados.length === 0 && !piezaActualValida && !otroProcesoInput.hasClass('is-invalid')) {
                // Esto es un caso especial, si "Otro" es la única opción y es válida.
            } else if (idsProcesosParseados.length === 0 && !otroProcesoTexto) {
                // Si no hay IDs numéricos Y no hay texto de "otro proceso", la pieza no es válida en cuanto a procesos.
                // La validación de arriba ya debería haberlo capturado.
            }


            piezasArray.push({
                id_pieza: parseInt(nombreInput.val()), // Enviar id_pieza en lugar de nombre_pieza
                cantidad: parseInt(cantidadInput.val()),
                tamano: $pieceGroup.find('.pieza-tamano').val() || null,
                montaje: $pieceGroup.find('.pieza-montaje').val() || null,
                tamano_montaje: $pieceGroup.find('.pieza-tamano-montaje').val() || null,
                material: $pieceGroup.find('.pieza-material').val() || null,
                cantidad_material: $pieceGroup.find('.pieza-cantidad-material').val() || null,
                ids_procesos: idsProcesosParseados,
                otro_proceso: otroProcesoTexto,
                descripcion_pieza: $pieceGroup.find('.pieza-descripcion').val() || null
            });
        }
    });

    if (!formValido || !piezasValidas) {
      $(form).addClass('was-validated');
      if (!formValido) {
        $(form).find(':invalid').first().focus();
      } else if (!piezasValidas) {
           alert("Por favor, complete todos los campos requeridos para cada pieza (Nombre, Cantidad y Proceso(s)). Si seleccionó 'Otro' proceso, especifíquelo.");
           $('.piece-form-group').find('.pieza-campo.is-invalid, .select2-dynamic-piece + .select2-container.is-invalid-select2, .pieza-otro-proceso.is-invalid').first().each(function(){
               if ($(this).is('select')) {
                   $(this).next('.select2-container').find('.select2-search__field').focus();
               } else {
                   $(this).focus();
               }
           });
      }
      return false; 
    }
    
    $('#piezasData').val(JSON.stringify(piezasArray));
    
    if (isSubmitting) { return false; }
    isSubmitting = true;
    submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...');
    const formData = new FormData(form);
    console.log("FormData preparado. Listo para enviar AJAX a:", form.action); // DEBUG
    
    // Para depurar qué contiene formData:
    // for (var pair of formData.entries()) {
    //    console.log(pair[0]+ ': ' + pair[1]);
    // }

    $.ajax({
      url: form.action, type: 'POST', data: formData, contentType: false, processData: false,
      success: function(response) {
        if (response.status === 'success') {
            alert(response.message || 'Orden de Producción guardada con éxito.');
            window.location.href = response.redirect_url || "{{ url_for('lista_op') }}";
        } else {
            alert('Error al guardar la OP: ' + (response.message || 'Error desconocido. Revise los datos e inténtelo de nuevo.'));
        }
      },
      error: function(xhr) {
        let errorMsg = 'Error en la comunicación con el servidor.';
        try { const errResponse = JSON.parse(xhr.responseText); if (errResponse && errResponse.message) errorMsg = errResponse.message; else if (errResponse && errResponse.error) errorMsg = errResponse.error; } catch (e) {}
        alert(errorMsg);
      },
      complete: function() {
        isSubmitting = false;
        submitBtn.prop('disabled', false).html('Guardar Registro <i class="bi bi-save ms-2"></i>');
      }
    });
  });
});
</script>
{% endblock %}